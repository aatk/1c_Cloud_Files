
&НаСервере
Процедура ЗаполнитьТаблицу(Массив)
	
	СоответствияФайловИКартинов = Новый Структура();
	СоответствияФайловИКартинов.Вставить("HTML4", БиблиотекаКартинок.ФорматHTML);
	СоответствияФайловИКартинов.Вставить("PDF"  , БиблиотекаКартинок.ФорматPDF);
	СоответствияФайловИКартинов.Вставить("XLSX" , БиблиотекаКартинок.ФорматExcel2007);
	СоответствияФайловИКартинов.Вставить("XLS"  , БиблиотекаКартинок.ФорматExcel);
	СоответствияФайловИКартинов.Вставить("ODS"  , БиблиотекаКартинок.ФорматOpenOfficeCalc);
	СоответствияФайловИКартинов.Вставить("MXL"  , БиблиотекаКартинок.ФорматMXL);
	СоответствияФайловИКартинов.Вставить("DOCX" , БиблиотекаКартинок.ФорматWord2007);
	СоответствияФайловИКартинов.Вставить("TXT"    	, БиблиотекаКартинок.ФорматTXT);
	СоответствияФайловИКартинов.Вставить("ANSITXT"	, БиблиотекаКартинок.ФорматTXT);
	СоответствияФайловИКартинов.Вставить("JPG" 		, БиблиотекаКартинок.Картинка);
	СоответствияФайловИКартинов.Вставить("GIF"    	, БиблиотекаКартинок.Картинка);
	СоответствияФайловИКартинов.Вставить("BMP"		, БиблиотекаКартинок.Картинка);
	СоответствияФайловИКартинов.Вставить("PNG"		, БиблиотекаКартинок.Картинка);
	
	
	Объект.СписокФайлов.Очистить();
	Для Каждого ЭлементМассива ИЗ Массив Цикл
		СтрокаСФайлом = Объект.СписокФайлов.Добавить();
		СтрокаСФайлом.Наименование = ЭлементМассива.Получить("name");
		
		ВыбФайл = Новый Файл(СтрокаСФайлом.Наименование);
		СтрокаСФайлом.Расширение = ВРег(СтрЗаменить(ВыбФайл.Расширение,".",""));
		
		Если СоответствияФайловИКартинов.Свойство(СтрокаСФайлом.Расширение) Тогда
			СтрокаСФайлом.Картинка = СоответствияФайловИКартинов[СтрокаСФайлом.Расширение];
		Иначе
			СтрокаСФайлом.Картинка = БиблиотекаКартинок.ФорматПустой;
		КонецЕсли;
		
		СтрокаСФайлом.Размер = ЭлементМассива.Получить("size")/1024; //Кб
		СтрокаСФайлом.md5 = ЭлементМассива.Получить("md5");
	КонецЦикла;
	
КонецПроцедуры

&НаСервере
Процедура ОбновитьТаблицу()
	
	Если ЗначениеЗаполнено(Объект.Сервер) Тогда
		ОбъектСервер = РеквизитФормыВЗначение("Объект");
		
		Родитель = Строка(Объект.Родитель.УникальныйИдентификатор());
		HTTPЗапрос = Новый HTTPЗапрос(Объект.Скрипт+"getlist/"+Родитель);
		Соединение = Новый HTTPСоединение(Объект.Сервер);
		HTTPОтвет = Соединение.Получить(HTTPЗапрос);
		Тело = HTTPОтвет.ПолучитьТелоКакСтроку("UTF-8");
			
		Если Тело <> "" Тогда
			Результат = ОбъектСервер.ПрочитатьJSON(Тело);
			ЗаполнитьТаблицу(Результат);
		КонецЕсли;

	КонецЕсли;
	
КонецПроцедуры


&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
	
	ЭтаФорма.Параметры.Свойство("Владелец",Объект.Родитель);
	
	Если НЕ ЗначениеЗаполнено(Объект.Родитель) Тогда
		Отказ = Истина;
		Возврат; //Нет смысла открывать форму без владельца
	КонецЕсли;
	
	Попытка
		Если РольДоступна("ПолныеПрава") ИЛИ РольДоступна("Администратор") Тогда
			Элементы.ФормаОткрытьНастройки.Видимость = Истина;
		КонецЕсли;
	Исключение
		Элементы.ФормаОткрытьНастройки.Видимость = Ложь;
	КонецПопытки;
	
	СтрокаСНастройками = Константы.НастройкиОбменаФайлами.Получить();
	Если ЗначениеЗаполнено(СтрокаСНастройками) Тогда
		Настройки = ЗначениеИзСтрокиВнутр(СтрокаСНастройками);
		ЗаполнитьЗначенияСвойств(Объект, Настройки);
		
		ОбновитьТаблицу();
	КонецЕсли;
	
КонецПроцедуры

&НаКлиенте
Процедура ОткрытьНастройки(Команда)
	ОткрытьФорму("Обработка.ПрикрепленинеФайлов.Форма.УстановитьНастройки");
КонецПроцедуры

&НаКлиенте
Процедура СписокФайловВыбор(Элемент, ВыбраннаяСтрока, Поле, СтандартнаяОбработка)
	
	Каталог = КаталогВременныхФайлов();
	ИмяВыходногоФайла = Каталог+Элемент.ТекущиеДанные.Наименование; //ПолучитьИмяВременногоФайла(Элемент.ТекущиеДанные.Расширение);
	md5 = Элемент.ТекущиеДанные.md5;
	
	HTTPЗапрос = Новый HTTPЗапрос(Объект.Скрипт+"file/"+md5);
	Соединение = Новый HTTPСоединение(Объект.Сервер);
	Соединение.Получить(HTTPЗапрос, ИмяВыходногоФайла);
	
	ЗапуститьПриложение( ИмяВыходногоФайла );
КонецПроцедуры

&НаКлиенте
Процедура ОбработкаОповещения(ИмяСобытия, Параметр, Источник)
	Если ИмяСобытия = "ОбновитьТаблицу" Тогда
		ОбновитьТаблицу();
	КонецЕсли;
КонецПроцедуры

&НаКлиенте
Процедура ПрикрепитьФайл(Команда)
	Форма = ПолучитьФорму("Обработка.ПрикрепленинеФайлов.Форма.Форма",, Объект.Родитель);
	Форма.ОтправитьФайл(Строка(Объект.Родитель.УникальныйИдентификатор()));
КонецПроцедуры

&НаКлиенте
Процедура УдалитьФайл(Команда)
	
	Если ЗначениеЗаполнено(Элементы.СписокФайлов.ТекущаяСтрока >= 0) Тогда
		ТекущаяСтрока =Элементы.СписокФайлов.ТекущиеДанные;
		md5 = ТекущаяСтрока.md5;
		Родитель = Строка(Объект.Родитель.УникальныйИдентификатор());
		
		HTTPЗапрос = Новый HTTPЗапрос(Объект.Скрипт+"file/"+md5+"?parent="+Родитель);
		Соединение = Новый HTTPСоединение(Объект.Сервер);
		HTTPОтвет = Соединение.Удалить(HTTPЗапрос);
		Если (HTTPОтвет.КодСостояния = 200) Тогда
			Сообщить("Файл удален!");
		Иначе
			Тело = HTTPОтвет.ПолучитьТелоКакСтроку("UTF-8");
			Сообщить(Тело, СтатусСообщения.ОченьВажное);
		КонецЕсли;
		
		ОбновитьТаблицу();
	КонецЕсли;
	
КонецПроцедуры
